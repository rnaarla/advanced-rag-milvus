name: CI/CD

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*', 'release-*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  packages: write

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  COVERAGE_FAIL_UNDER: "95"
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  DAST_TARGET_URL: ${{ secrets.DAST_TARGET_URL }}

jobs:
  lint-test:
    name: Lint, Test, Coverage
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: [ "3.10", "3.11", "3.12", "3.13" ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install -U pip setuptools wheel
          pip install -r requirements.txt
          pip install coverage bandit pip-audit

      - name: Lint (flake8)
        run: |
          flake8 advanced_rag

      - name: Security audit (pip-audit)
        run: |
          pip-audit -r requirements.txt
        continue-on-error: true

      - name: Unit tests with coverage (>=%{{ env.COVERAGE_FAIL_UNDER }}%)
        run: |
          python -m coverage run -m pytest -q
          python -m coverage report -m --fail-under=${{ env.COVERAGE_FAIL_UNDER }}
          python -m coverage xml
      - name: Run Alembic migrations (SQLite)
        env:
          DATABASE_URL: sqlite:///./ci_migrate.db
        run: |
          alembic upgrade head

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

  secrets-scan:
    name: Secrets Scan (Gitleaks)
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        uses: zricethezav/gitleaks-action@v2
        with:
          args: --no-git -v
        continue-on-error: true

  semgrep-sast:
    name: Semgrep SAST (OWASP Top 10)
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        with:
          config: p/owasp-top-ten
        continue-on-error: true

  iac-scan:
    name: IaC Scan (tfsec)
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - uses: actions/checkout@v4
      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infra/terraform/aws
        continue-on-error: true

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - uses: actions/checkout@v4
      - name: Generate SBOM (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          path: .
          artifact-name: sbom-cyclonedx
          format: cyclonedx-json

  sast:
    name: SAST (Bandit, Trivy FS)
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SAST tools
        run: |
          python -m pip install -U pip
          pip install bandit

      - name: Bandit scan
        run: |
          bandit -r advanced_rag -q -ll

      - name: Trivy FS scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  db-migrate:
    name: Postgres Migrations
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: raguser
          POSTGRES_PASSWORD: ragpass
          POSTGRES_DB: ragdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U raguser" 
          --health-interval 10s 
          --health-timeout 5s 
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Alembic
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt
      - name: Run Alembic migrations (Postgres)
        env:
          DATABASE_URL: postgresql://raguser:ragpass@localhost:5432/ragdb
        run: |
          alembic upgrade head

  docker:
    name: Build Docker image
    runs-on: ubuntu-latest
    needs: [ lint-test, sbom, secrets-scan, semgrep-sast, iac-scan, sast, db-migrate ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Dockerfile
        id: df
        shell: bash
        run: |
          if [ -f Dockerfile ]; then echo "present=true" >> "$GITHUB_OUTPUT"; else echo "present=false" >> "$GITHUB_OUTPUT"; fi

      - name: Log in to GHCR
        if: steps.df.outputs.present == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        if: steps.df.outputs.present == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}

      - name: Build and push
        if: steps.df.outputs.present == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  trivy-image:
    name: Trivy Image Scan
    runs-on: ubuntu-latest
    needs: [ docker ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Dockerfile
        id: df
        shell: bash
        run: |
          if [ -f Dockerfile ]; then echo "present=true" >> "$GITHUB_OUTPUT"; else echo "present=false" >> "$GITHUB_OUTPUT"; fi

      - name: Pull image
        if: steps.df.outputs.present == 'true'
        run: |
          docker pull ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
        continue-on-error: true

      - name: Trivy image scan
        if: steps.df.outputs.present == 'true'
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          ignore-unfixed: true
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
        continue-on-error: true

  smoke:
    name: Smoke Test Container
    runs-on: ubuntu-latest
    needs: [ docker ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Dockerfile
        id: df
        shell: bash
        run: |
          if [ -f Dockerfile ]; then echo "present=true" >> "$GITHUB_OUTPUT"; else echo "present=false" >> "$GITHUB_OUTPUT"; fi

      - name: Run container
        if: steps.df.outputs.present == 'true'
        run: |
          docker run -d --name rag-svc -p 8000:8000 ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
          sleep 5
          curl -fsS http://localhost:8000/healthz
      - name: Stop container
        if: always()
        run: |
          docker logs rag-svc || true
          docker rm -f rag-svc || true

  dast:
    name: DAST (OWASP ZAP Baseline)
    runs-on: ubuntu-latest
    needs: [ lint-test ]
    steps:
      - name: ZAP Baseline Scan
        if: ${{ env.DAST_TARGET_URL != '' }}
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.DAST_TARGET_URL }}
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

  deploy:
    name: Deploy (AWS)
    runs-on: ubuntu-latest
    needs: [ docker, trivy-image, smoke ]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Python (for Alembic)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install app requirements
        run: |
          python -m pip install -U pip
          pip install -r requirements.txt

      - name: Run Alembic migrations (Prod)
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
        run: |
          alembic upgrade head

      - name: Terraform init
        working-directory: infra/terraform/aws
        run: terraform init -input=false

      - name: Terraform apply (image tag)
        env:
          TF_VAR_image_tag: ${{ github.sha }}
        working-directory: infra/terraform/aws
        run: terraform apply -auto-approve -input=false -var "image_tag=${{ github.sha }}"

      - name: Get ALB DNS
        id: alb
        working-directory: infra/terraform/aws
        run: |
          echo "dns=$(terraform output -raw alb_dns_name)" >> "$GITHUB_OUTPUT"

      - name: Smoke check ALB
        run: |
          echo "ALB: ${{ steps.alb.outputs.dns }}"
          curl -fsS http://${{ steps.alb.outputs.dns }}/healthz

  # Optional: CodeQL SAST (requires code scanning enabled)
  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3


